---
layout: default
title: Handling alert for Argonauts Access Reconciliation Job
type: Operations
runbook-name: "argonauts-access-reconcile-iks-jenkins-job-has-failed"
description: "This runbook describes how to handle errors in Access Reconcile IKS Jenkins Job"
service: Conductors
link: ./argonauts-access-reconcile-iks-jenkins-job-has-failed.html
parent: Armada Runbooks

---

Ops
{: .label .label-green}


## Overview
[Usam-sync](https://github.ibm.com/mhub/usam-sync) is a tool for re-reconciling user permissions. Taking the list of users in a github org as a source of truth, it ensures the permissions these users have across a number of other backend systems and accounts is consistent with a pre-defined config, creating, deleting and modifying users and their permissions as required. It is intended to be used alongside AccessHub in order to help meet the compliance requirements for the Service Framework requirement.

## Detailed Information
Jenkins automation is available to run the mentioned synchronization tool above for IKS permissions. Required scripts and sync tool configuration files are found [here](https://github.ibm.com/argonauts-access/role-config/tree/master/iks/jenkins).

This job in particular takes users, their roles (from AccessHub) and role mappings from roles to Access Groups defined in our [repo](https://github.ibm.com/argonauts-access/role-config/blob/master/iks/iam/com_ibm_cloud/argonauts-production.json) and then applies changes such that the users then gain the Access Groups which they need.

## Example alerts
The following alert can be generated by the Jenkins job:

- `Argonauts-access-reconcile-iks jenkins job has failed.`

## Detailed Procedure
Alert fires - [link to Jenkins job](https://alchemy-conductors-jenkins.swg-devops.com/job/Conductors/job/Security-Compliance/job/compliance-argonauts-access-reconcile-iks/)

Look in the Jenkins job output to find the reason for failure. Look for the following phrase and the `ERROR` will be just above:
```
Return code from sync tool was:
```

If the message above is not in the job's output, go [here](#message-exists), otherwise keep reading.

Take note of the code returned after `Return code from sync tool was:`. 

The [list below](#error-list) contains the possible error codes returned from the sync tool along with their corresponding error messages, select the item that matches the error code encountered. 

<a id="message-exists"></a>If the message `Return code from sync tool was:` was not found in the job's output, select the option for 'No code' from the list below.

<a id="error-list"></a>

| Error Code | Error message |
| ------ | ------- |
| 2 | [Failed to setup configuration](#error-code-2-failed-to-setup-configuration) |
| 3 | [failed to read credentials](#error-code-3-failed-to-read-credentials) |
| 8 | [failed to initialize auth system types](#error-code-8-failed-to-initialize-auth-system-types) |
| 9 | [failed to read the required accesses (the message varies)](#error-code-9-failed-to-read-the-required-accesses)  |
| 11 | [failed to assign user <user> to authsystems](#error-code-11-failed-to-assign-user-to-authsystems) |
| 12 | [ERROR - failed to process auth systems](#error-code-12-failed-to-process-auth-systems) |
| No code | [Other discovered errors (to date)](#other-discovered-errors-to-date) |


---
**Note**

Some common job errors and actions can be found [here](https://github.ibm.com/argonauts-access/role-config#common-reconciliation-job-errors).

---

### Error code 2: Failed to setup configuration

The sync tool failed to read its own config, either from a file or command line args, logs should show which source and what the error was. This error is most likely due to an incorrect change in the [role-config](https://github.ibm.com/argonauts-access/role-config/pulls) repo.

#### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

### Error code 3: Failed to read credentials

The sync tool failed to get the credentials it needs for its own access, this could be due to a communication error with SOS vault. 

#### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

### Error code 8: Failed to initialize auth system types

The tool failed to initialize with the authorization systems to sync with, check logs to find the cause. 

Some specific errors with code 8 can be found in the below sub-category(-ies). 

#### SoftLayer credentials error
The job relies on secrets for accessing information. If there is an issue with secrets, we may see errors of this type.

Example entry from the job output:
```
IAM/SoftLayer failed to initialize auth system types: Missing credential softlayer-1455723
Return code from sync tool was:8
```

In the case above, the error is due to an incorrect change in the [role-config](https://github.ibm.com/argonauts-access/role-config/pulls) repo. This error occurs when there is no entry for the IAM or SoftLayer account in `ikscreds.yaml`. Most likely this requires a config fix and a re-run.

##### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

#### Other failed-to-initialize-auth-system-type errors
##### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

### Error code 9: Failed to read the required accesses

The sync tool failed to read the required accesses for users from the source of truth (e.g. AccessHub), check logs for the cause.

The above error is caused by a failure to authenticate to the GitHub API. 

- Check the logs for potential network errors. 
- Check if the user email has been passed correctly to the sync tool or if there was a mapping error.

Some specific errors with code 9 can be found in the below sub-category(-ies). 

#### Rate-limiting errors
The job may be rate-limited by upstream services if run too often. The rate-limiting can take up to an hour to reset.
```
Error Getting RBAC Team details: GET https://github.ibm.com/api/v3/orgs/argonauts-access/teams?page=3&per_page=50: 403 API rate limit of 5000 still exceeded until 2021-10-19 12:34:22 +0000 UTC, not making remote request. [rate reset in 24m59s]
Return code from sync tool was:9
```

##### Resolution action
In this case, first stop any running build in the [Dev/Test](https://alchemy-conductors-jenkins.swg-devops.com/job/Conductors/view/A.A.R%20and%20M%20-%20Dev,%20CI-CD/job/Security-Compliance/job/compliance-argonauts-access-reconcile-iks--CICD--Dev_Test/) version of the Jenkins job and then disable the Jenkins job (blue button that reads `DISABLE PROJECT`  on the main page of the job). This is to allow the Prod version of the job to run.

Leave a note in the [#sre-accesshub-team](https://ibm-argonauts.slack.com/archives/G01LJ0V9FBK) Slack channel to inform the job is disabled. When the rate-limiting errors are gone, then the job can be re-enabled if needed. 

Resolve the alert and the job will run on the next scheduled attempt.

#### Other failed-to-read-required-accesses-type errors
##### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

### Error code 11: Failed to assign user to authsystems

The sync tool failed to build the internal map of users to systems they should have access to.  Most likely a config error occurred.

#### Resolution action

- Check logs for the cause. Either the user name or the permisions that the user can be granted are empty, the log should show which user. 

- Follow the [Escalation Policy](#escalation-policy).

### Error code 12: Failed to process auth systems

The sync tool failed to update the actual access permissions of users to the required access, check logs for cause.
This could be a network error. This error is also caused by a user ID without a valid email address. This error is also caused by non-existent user in access groups.

Some specific errors with code 12 can be found in the below sub-category(-ies). 

#### Delete Safeguard Threshold exceeded
If the sync would delete too many users for a given account, we will see the following error:
```
ERROR - failed to process auth systems: Delete safeguard for deleting users in 'Alchemy Staging's Account' has tripped: would delete 14 users above threshold of 10: [user1@uk.ibm.com user2@uk.ibm.com ... user14@ibm.com]
Return code from sync tool was:12
```

This safeguard is to prevent the scenario of an upstream problem leading to users being erroneously removed by the sync job.

##### Resolution action

- Disable the jenkins job, as there may be an upstream problem which would cause repeated failures.
- Follow the [Escalation Policy](#escalation-policy).
- Include a note in the GHE issue that the proposed user deletions should be investigated per the role-config [README](https://github.ibm.com/argonauts-access/role-config/blob/master/README.md), and that a follow-up action of re-running the job with `DELETE_SAFEGUARD_ON=FALSE` should be considered.

#### Timeout errors - upstream services
If there is a problem with an upstream service, we will see `context deadline exceeded` errors like one of the following:
```
ERROR - failed to process auth systems: unsuccessful attempt 3: Get "https://user-management.cloud.ibm.com/v2/accounts/e3feec44d9b8445690b354c493aa3e89/users": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Return code from sync tool was:12
```
```
ERROR - failed to process auth systems: failed to connect to account IKS.Prod.VPC.Service:failed login, unsuccessful attempt 3: Post "https://iam.cloud.ibm.com/oidc/token": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Return code from sync tool was:12
```

##### Resolution action
If you see an error similar to the above in the job's output, check the appropriate slack channels for notices of upstream issues: 

- For IAM issues check the [#iam-issues](https://ibm-argonauts.slack.com/archives/C3C46LY7N) Slack channel.
- For user management issues check the [#bss](https://ibm-cloudplatform.slack.com/archives/C081NLV9U) Slack channel.
- For mccp issues check the [#mccp](https://ibm-cloudplatform.slack.com/archives/C2QR2DX2A) Slack channel.
- For Softlayer issues check the [#softlayer](https://ibm-cloudplatform.slack.com/archives/C6MNCAJ4W) Slack channel.

If there is a confirmed upstream issue or network issue, reach out to the [#sre-accesshub-team](https://ibm-argonauts.slack.com/archives/G01LJ0V9FBK) channel on Slack for help.

#### SoftLayer access error
Example entry from the job output:
```
SoftLayer ERROR - failed to process auth systems: SoftLayer_Exception_Public: Access Denied. (HTTP 401)
Return code from sync tool was:12
```

This error occurs when the username or API key entry in `ikscreds.yaml` is incorrect.

Typically the username is `acctnumber_alchcond@uk.ibm.com` (e.g. `1186049_alchcond@uk.ibm.com`) for SoftLayer, but for some accounts the username was different. Whatever credentials being used, do not have the necessary access permisions.

##### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

#### Other process-auth-systems-type errors
##### Resolution action
- Follow the [Escalation Policy](#escalation-policy).

<a id="#other-discovered-errors-to-date"></a>
### Other discovered errors (to date)

#### Job did not run properly 
Sometimes there might be failed jobs that say that they took 0 ms to run. There will be no errors in the Output Console for this. This is probably an error inherent to Jenkins.

##### Resolution action
Re-running the job should fix this.

#### Network errors (non usam-sync related)
Example entry from the job output:
```
ERROR - failed to process auth systems: unsuccessful attempt 3: the return code (500) does not match what is expected ([200]). Response: {"trace":"24377037366","errors":[{"code":1003,"message":"External Dependency issue, Cloudfoundry, UAA, MCCP, Cloudant etc.","more_info":"Can not get users from database. (error happened in your connection)"}]}
```
##### Resolution action
If this happens re-run the Jenkins job and resolve the alert.

### Other helpful actions
- Check the [#taas-jenkins-help](https://ibm-argonauts.slack.com/archives/C56Q2JUKS) channel on Slack for possible outages, unusual errors or errors inherent to Jenkins. Re-running the job will fix most of the aforementioned errors. You can re-run the job immediately or wait for the next automatic run 4 hours later.

- Reach out to [#access-sync](https://ibm-argonauts.slack.com/archives/C016P71CYG3) channel on Slack, this is a community of users of the sync tool, i.e usam-sync (it is not a support channel).

- Follow the [Escalation Policy](#escalation-policy).

## Escalation Policy
- Create a new GitHub issue in the [SRE Team GHE repository](https://github.ibm.com/alchemy-conductors/team/issues), and do the following:

    - When pressented with a list of issue types, select the option "Don’t see your issue here? Open a blank issue." at the very bottom of the page.

    - Add the following to the new issue being created:

        - The URL of the alert (PagerDuty).
        
        - The URL of the console output of the failed build from Jenkins.

        - From the same console ouput of that failed build, copy the error that was fired and paste it into the GitHub issue.

        - Add the `accesshub` label to the issue in the `Labels` section.

        - Submit the new GitHub issue.

- Add a note in the Handover providing the link to the GitHub issue just created in the step above.

- Post the GitHub issue in the [#sre-accesshub-team](https://ibm-argonauts.slack.com/archives/G01LJ0V9FBK) channel on Slack.
