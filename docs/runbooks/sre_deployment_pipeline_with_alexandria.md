---
layout: default
title: IKS SRE deploymeny pipeline
type: Informational
runbook-name: "IKS SRE deploymeny pipeline with Alexandria"
description: "Overview of IKS SRE deploymeny pipeline with Alexandria"
service: Conductors
link: /sre_deployment_pipeline_with_alexandria.html
parent: Armada Runbooks

---

Informational
{: .label }

## Overview

This document details how the IKS SRE deploymeny pipeline works with NetInt's [Alexandria](https://github.ibm.com/alchemy-netint/alexandria). The IKS SRE deploymeny pipeline is used to build, test, premote and deploy SRE automation, tooling and bots in an FS/FEDRAMP compliant way. This document details:

- A conceptual [overview of Alexandria](#alexandria-overview).
- [IKS SRE deployment pipeline overview](#iks-sre-deployment-pipeline-overview)
- [Useful Links](#useful-links)
- [Prod promotion via Hypatia](#prod-promotion-via-hypatia)
- [Prod promotion via Astrolabe](#prod-promotion-via-astrolabe)
- [Detailed steps of interrupt bot deployment pipeline](#detailed-steps-of-interrupt-bot-deployment-pipeline)
- [Configuration steps](#configuration-steps)

## Alexandria overview

Alexandria is a runtime comprised of a number of microservices used to deploy applications in an automated manor. There are number of predefined setpieces (Healthcheck, Gate, Action, Test, Complete, Cleanup) which can be used by Alexandria to trigger various types of automated tasks.

Alexandria isolates teams using orgs. An org can be created using the Slack bot Hypatia, by running `@hypatia create org <orgname> here` in the channel you wish to use.

There are three main conponent to configure for an application to use Alexandria. The application config, pipeline config and process, which are detailed in the section below.

### Application config

An app config is defined by a json file which provides all the details required, such as:

- Deployment config (set pieces required for deployment)
- Promotion config (set pieces required for promotion)
- Ability to auto release, promote, deploy
- Release number
- ID generated by Alexandria
- App name

### Pipeline config

The pipeline config is also defined by a json file which provides all the details required to orchestrate the application config. In the pipeline you can specify which set pieces are ran for each environment and the order they are ran in.

### Process

A process can created for each component required in a stack deployment. For example, you could deploy a application with independant processes for, webserver, frontend, DB etc, which could all be deployed together under one application.

## Detailed information

This section will firstly give a brief overview of the deployment pipeline, then the following section will detail every step involed.

### IKS SRE deployment pipeline overview

The pipeline consists of 4 Jenkins Jobs which:

- Build: Builds an image and store the STATIC_UTS and STATIC_CODE_VULN results
- Image Scan: Pulls the new image and perform an vulnerability scan
- Deploy: Deploys to requested environment(s), zone(s) and cluster(s)
- ZAP Scan: Run a dynamic scan against the deployed container

![Deployment Diagram](https://raw.github.ibm.com/alchemy-conductors/documentation-pages/iks-deployment-pipeline/docs/runbooks/deployment%20pipeline.png?token=AAA24XBAZOHKTC7ICQ4IBC3BDPBIS)

On merge interrupt bot with automatically build an image and deploy to stage, once all of the tests have passed successfully. To promote the interrupt bot to prod SRE will need to interact with Alexandria using either Hypatia (Alexandria Slack bot) or Astrolabe (Alexandria UI).

### Prod promotion via Hypatia

To promote interrupt bot to the prod environment:

- Go to [#iks-sre-deploy](https://ibm-argonauts.slack.com/archives/C024L2BABL0) slack channel.
- To find the latest version you can run `@hypatia get app <app_name>`
- To find the pipeline name run `@hypatia list pipelines`
- To promote you can run the following command `@hypatia promote <app_name> version <app_version> in <pipeline_name> to <destination_env> all <destination_zone>`

### Prod promotion via Astrolabe

To promote interrupt bot to the prod environment:

- Go to [Astrolabe]() (NEED TO ADD URL TO LINK!!)
- Enter your org key
- Select the appropriate app
- Click deployment status
- From this page you can click promote to prod button

### Detailed steps of interrupt bot deployment pipeline

1. PR is created against the relavant application repository.
1. Upon creation of the PR, STATIC_UTS and STATIC_CODE_VULN are automatically run in travis.
1. Code changes are reviewed, approved and merged.
1. Jenkins image build job is triggered on merge to master.
1. STATIC_UTS and STATIC_CODE_VULN results are retrieved from from GHE commit using [prpl](https://github.ibm.com/alchemy-netint/prpl) and written locally to a logs.json file.
1. logs.json is checked to confirm that the tests were successful. If not the build will fail.
1. Image is pushed to de.icr.io registry and tagged with `$IMAGE_NAME:$BUILD_ID`
1. Alexandria microservice [axctl](https://github.ibm.com/alchemy-netint/alexandria/tree/master/axctl) is used to create a new app version: `axctl -t $IKS_SRE_DEPLOY_KEY new version -p ${SERVICE} '{ "buildNumber": '${BUILD_NUMBER}', "SHA": "'${GIT_COMMIT}'", "kind": "Container Image", "url": "'de.icr.io/alchemy_conductors/$SERVICE'", "process": "'${SERVICE}'" }'`
1. [loglug](https://github.ibm.com/alchemy-netint/loglug) is then used to push the successful STATIC_UTS and STATIC_CODE_VULN results to a COS instance.
1. axctl is used again to add the Test results to the the app release using the following command:`axctl -t $IKS_SRE_DEPLOY_KEY new gateTestResults -a "interrupt" -r $RELEASE -k validation '{ "url": '$LOGS_URL', "hash": '$LOGS_CHECKSUM', "ranAt": "'$TIMESTAMP'", "environment": "build", "zone": "jenkins", "success": true, "gateTestsKind": "validation", "jobType": "JenkinsJob", "phase": 4 }'`
1. Since interrupt bot was configured to AutoRollout, Alexandria then triggers the next steps of the deployment. Which is the Jenkins [Image scanner](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/image-scan-puller-test/) job.
1. [imscap](https://github.ibm.com/alchemy-netint/image-scan-puller) is used to pull images from the repository and run a vulnerability assessment (VA) scan.
1. The scan status is written to a local json file and uploaded to a COS instance with loglug.
1. If the scan status is not ok then the job fails.
1. axctl is used to append these results to the Alexandria release.
1. AutoDeploy is enabled for interrupt bot, which means Alexandria will trigger the deployment pahses defined of each stage within the pipeline config. For interrupt bot stage env those phases are: Gate, Action, Test, Cleanup.
1. The Gate phase runs an Elba job to compile the train template information used to request the appropritae train, with all the required information.
1. The Action phase contiains a create train job, Jenkins job and a comlete train job.
1. A stage train using the train template created by the Elba job.
1. Once the train is approved the [deploy job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/test-helm-deploy-v2/) is triggered.
1. [squirrel](https://github.ibm.com/alchemy-netint/squirrel) is used to retrieve secrets from a kube secret in the AAA cluster and output a values.yaml file: `squirrelctl --namespace=sre-bots --secretsVersion=3 template --env="'$ENV'" --template=${ENV}-values.tmpl --out=values.yaml`.
1. helm template is then used to create a deploy.yaml file: `helm template . --values=values.yaml --set buildid=$UPSTREAM_BUILD_ID  > ./deploy.yaml`.
1. The deployment is completed using the kube apply command: `kubectl apply -f ./deploy.yaml -n $NAMESPACE`.
1. The second train job is used to complete the stage train.
1. The Test phase will then run the [zap scanning job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/zap-scan-test) against the container deployed in stage, to test the dynamic security of the running container.
1. If the scan succeeds, it will output an archive to $RELEASE.tgz
1. loglug adds the test results to a COS instance.
1. axctl adds these results to the Release.
1. The Cleanup phase is only used abort trains if they have not succesfully completed.
1. AutoPromote is not enabled for interrupt bot, so SRE will need to manually promote to the next environment via Hypatia or Astrolabe. (See [Prod promotion via Hypatia](#prod-promotion-via-hypatia) or [Prod promotion via Astrolabe](#prod-promotion-via-astrolabe) for instructions)
1. Alexandria will then begin the deployment phases for prod, which in the case of interrupt is Gate, Action, Cleanup.
1. This time the Gate phase will create a prod train template with the Elba job and also include the zamp-scan results.
1. Action phase will be the same as stage only the parameters for the Jenkins job will get secrets for the prod env. Train start and complete are similar to stage environment.
1. Hurray! Interrupt is now deployed in prod.

## Useful links

[iks-sre-deploy](https://ibm-argonauts.slack.com/archives/C024L2BABL0) slack channel

### Repos

- [Alexandria Repo](https://github.ibm.com/alchemy-netint/alexandria)
- [prpl](https://github.ibm.com/alchemy-netint/prpl)
- [loglug](https://github.ibm.com/alchemy-netint/loglug)
- [imscap](https://github.ibm.com/alchemy-netint/image-scan-puller)
- [squirrel](https://github.ibm.com/alchemy-netint/squirrel)
- [Interrupt Repo](https://github.ibm.com/sre-bots/interrupt)

### Jenkins Jobs

- [Interrupt build job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/interrupt-test/)
- [Image scanner job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/image-scan-puller-test/)
- [Deploy job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/test-helm-deploy-v2/)
- [Zap scan job](https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/zap-scan-test/)

## Configuration steps

This section gives detailed steps on how the IKS SRE deploymeny pipeline was configured for interrupt bot.

### How to configure a new app with Alexandria

1. Create a new channel in Slack
1. Add Hypatia bot to the Channel
1. Create a new org `@hypatia create org iks-sre-deploy here`
1. Hypatia will DM the org apikey: `<org-key>`
1. Clone Alexandria locally `git clone  git@github.ibm.com:alchemy-netint/alexandria.git`
1. Go to axctl directory: `cd /axctl/cmd/axctl`
1. Build go code: `go build`
1. Run axctl with `go run main.go -t <apikey> -help`
1. Need to create an app:

```json
{
  "Name": "interrupt",
  "PromotionConfig": {
    "Test": [
      {
        "Type": "JenkinsJob",
        "Body": {
          "URL": "https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/image-scan-puller-test/",
          "Params": {
            "APP_NAME": "{{ .SetPiece.App.Name }}",
            "RELEASE": "{{ .SetPiece.Release.Number }}",
            "PROMOTION_ID": "{{ .SetPiece.ID }}",
            "IMAGES": "{{ .SetPiece.Release.Versions.interrupt.URL }}:{{ .SetPiece.Release.Versions.interrupt.BuildNumber }}"
          },
          "Token": "<jenkins_token>",
          "User": "<jenkins_user>"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 10
      }
    ]
  },
  "DeploymentConfig": {
    "Action": [
      {
        "Type": "TrainJob",
        "Body": {
          "DesiredState": "Started",
          "TrainsKind": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage{{ else }}prod{{ end }}"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 0
      },
      {
        "Type": "JenkinsJob",
        "Body": {
          "URL": "https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/test-helm-deploy-v2/",
          "Params": {
            "CHART_NAME": "interrupt",
            "CHARTS_BRANCH": "adding-stage-tmpl",
            "CLUSTER_NAME": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}infra-accessallareas-stage{{ else }}infra-accessallareas{{ end }}",
            "BLUEMIX_ACCOUNT": "800fae7a41e7d4a1ec1658cc0892d233",
            "REGION": "eu-central",
            "UPSTREAM_BUILD_NAME": "interrupt",
            "UPSTREAM_BUILD_ID": "{{ .SetPiece.Release.Versions.interrupt.BuildNumber }}",
            "NAMESPACE": "sre-bots",
            "ENV": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage{{ else }}prod{{ end }}"
          },
          "Token": "<jenkin_token>",
          "User": "<jenkin_username>"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 3
      },
      {
        "Type": "TrainJob",
        "Body": {
          "DesiredState": "Complete",
          "TrainsKind": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage{{ else }}prod{{ end }}",
          "Comment": "Deployment successful"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 0
      }
    ],
    "Cleanup": [
      {
        "Type": "TrainJob",
        "Body": {
          "DesiredState": "Cancelled",
          "TrainsKind": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage{{ else }}prod{{ end }}",
          "Comment": "Deployment failed: {{ .SetPiece.Err.S }}"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 0
      }
    ],
    "Gate": [
      {
        "Type": "ElbaJob",
        "Body": {
          "Squad": "Conductors",
          "Service": "{{ .SetPiece.App.Name }}",
          "Title": "Deploying latest release for {{ .SetPiece.App.Name }}:{{ .SetPiece.Release.Number }}",
          "Environments": [
            "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage-us-south{{ else }}eu-central{{ end }}"
          ],
          "Details": "Latest version of {{ .SetPiece.App.Name }} ",
          "StageDeployDate": "{{ if .SetPiece.Release.GateTestResults.validation.RanAt }}{{ .SetPiece.Release.GateTestResults.validation.RanAt | fmtDeployDate }}{{ end }}",
          "PlannedDuration": 3600000000000,
          "BackoutPlan": "Revert to previous build",
          "TestsEnv": "stage",
          "TrainsKind": "{{ if eq .SetPiece.DestinationEnv.Name \"stage\" }}stage{{ else }}prod{{ end }}",
          "BOM": "{{ .SetPiece.Release | fmtBOM }}",
          "ValidationTests": [
            {
              "Name": "{{ if .SetPiece.Release.GateTestResults.validation.URL }}Validation tests{{ else }}Validation tests not required for stage trains{{ end }}",
              "URL": "{{ .SetPiece.Release.GateTestResults.validation.URL }}",
              "Hash": {
                "Md5Sum": "{{ .SetPiece.Release.GateTestResults.validation.Hash }}"
              },
              "Passed": true
            }
          ],
          "SecurityTests": [
            {
              "Name": "Static tests for alertmanager, grafana, prometheus, vialli",
              "URL": "{{ .SetPiece.Release.GateTestResults.security_static.URL }}",
              "Hash": {
                "Md5Sum": "{{ .SetPiece.Release.GateTestResults.security_static.Hash }}"
              },
              "Passed": true
            },
            {
              "Name": "{{ if .SetPiece.Release.GateTestResults.security_dynamic.URL }}Dynamic tests for prometheus stack{{ else }}Dynamic tests not required for stage trains{{ end }}",
              "URL": "{{ .SetPiece.Release.GateTestResults.security_dynamic.URL }}",
              "Hash": {
                "Md5Sum": "{{ .SetPiece.Release.GateTestResults.security_dynamic.Hash }}"
              },
              "Passed": true
            }
          ],
          "SecurityImpactAnalysis": "{{ .SetPiece.App.ConceptDocURL }}"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 3
      }
    ],
    "Test": [
      {
        "Type": "JenkinsJob",
        "Body": {
          "URL": "https://alchemy-containers-jenkins.swg-devops.com/job/Support/job/zap-scan-test/",
          "Params": {
            "PROMOTION_ID": "{{ .SetPiece.ID }}",
            "RELEASE": "{{ .SetPiece.Release.Number }}",
            "APP_NAME": "{{ .SetPiece.App.Name }}",
            "TARGET_URL": "Placeholder"
          },
          "Token": "<jenkins_token>",
          "User": "<jenkins_user>"
        },
        "AppendToRelease": false,
        "SetGateTest": "",
        "RetryLimit": 3
      }
    ]
  },
  "AutoRelease": false,
  "AutoRollout": true,
  "AutoDeploy": true,
  "AutoPromote": false,
  "ManualConfirm": false,
  "Processes": [
    "interrupt"
  ],
  "ConceptDocURL": "https://github.ibm.com/sre-bots/interrupt"
}
```

10. Create app `go run main.go -t <org_key> new app -i ~/Downloads/interrupt.json`
1. Find app id in Slack `@hypatia get app interrupt`
1. Create pipeline.json

```json
{
  "Name": "interrupt-deploy-pipeline",
   "Environments": [
    {
      "ID": "75045f874a9331b7eda27fcbaa34972cb50da4d440b590736f0eb779dba8da91",
      "Name": "stage",
      "NextEnvironments": [
        "6626a203baa80417cf68ed750ac36ed7e7db1792b3d346f2ecffe17cf21734f8"
      ],
      "Zones": [
        {
          "ID": "62d67777aee47c9d61e0ca864ddacfa669df643cb713caaa61166ccdce6cdfae",
          "Name": "eu-central",
          "RequiredPhases": [
            "Test"
          ],
          "DeploymentPhases": [
            "Gate",
            "Action",
            "Test",
            "Cleanup"
          ]
        }
      ]
    },
    {
      "ID": "6626a203baa80417cf68ed750ac36ed7e7db1792b3d346f2ecffe17cf21734f8",
      "Name": "prod",
      "NextEnvironments": [],
      "Zones": [
        {
          "ID": "0bd109af8da15c2cb1b945cae8c67d5fbad020ee9334cef01f36ce40d3147f81",
          "Name": "eu-central",
          "RequiredPhases": [],
          "DeploymentPhases": [
            "Gate",
            "Action",
            "Cleanup"
          ]
        }
      ]
    }
  ],
  "Apps": {
    "9b6665e0-7175-403b-b471-0e1e63d2a48d": {
      "ID": "9b6665e0-7175-403b-b471-0e1e63d2a48d",
      "Intended": {
        "6626a203baa80417cf68ed750ac36ed7e7db1792b3d346f2ecffe17cf21734f8": {
          "0bd109af8da15c2cb1b945cae8c67d5fbad020ee9334cef01f36ce40d3147f81": 71
        },
        "75045f874a9331b7eda27fcbaa34972cb50da4d440b590736f0eb779dba8da91": {
          "62d67777aee47c9d61e0ca864ddacfa669df643cb713caaa61166ccdce6cdfae": 71
        }
      },
      "Confirmed": {
        "6626a203baa80417cf68ed750ac36ed7e7db1792b3d346f2ecffe17cf21734f8": {
          "0bd109af8da15c2cb1b945cae8c67d5fbad020ee9334cef01f36ce40d3147f81": 71
        },
        "75045f874a9331b7eda27fcbaa34972cb50da4d440b590736f0eb779dba8da91": {
          "62d67777aee47c9d61e0ca864ddacfa669df643cb713caaa61166ccdce6cdfae": 71
        }
      }
    }
  }
}
```

14. Create pipeline: `go run main.go -t <org_key> new pipeline -i ~/Downloads/pipeline.json`
1. Create a new version of the app: `go run main.go -t <org_key> new version -p interrupt '{ "buildNumber": 1, "kind": "Container Image", "url": "'icr.io/test'", "process": "interrupt" }'`
1. Cut new release in Slack: `@hypatia cut release interrupt`
1. Promote release in Slack: `@hypatia promote interrupt version 1 in interrupt-deploy-pipeline to stage eu-central`
